<?xml version="1.0" encoding="UTF-8"?>
<ui:composition xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:c="http://java.sun.com/jsp/jstl/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:o="http://omnifaces.org/ui"
                xmlns:jsf="http://xmlns.jcp.org/jsf"
                xmlns:p="http://primefaces.org/ui">

    <h:form id="widgets-form">
        <p:dialog header="#{empty DashboardManagedBean.selectedProjectWidget ? msg['app.user.add.widget.modal.header'] : msg['app.user.edit.widget.modal.header']}"
                  widgetVar="widgetChooser"
                  modal="true"
                  width="70%"
                  resizable="false"
                  responsive="true"
                  fitViewport="true"
                  draggable="false"
                  id="widget-dialog"
                  closeOnEscape="true"
        >
            <p:ajax event="close" update="widget-dialog-content" listener="#{DashboardManagedBean.cancelWidget}" />
            <div jsf:id="widget-dialog-content">
                <o:commandScript action="#{DashboardManagedBean.addWidget}" name="selectedWidget" render="widget-dialog-content"/>
                <c:choose>
                    <c:when test="#{empty DashboardManagedBean.selectedWidget}">
                        <p:inputText styleClass="form-control"
                                     value="#{DashboardManagedBean.searchWidget}"
                                     placeholder="#{msg['app.user.widget.search']}"
                         >
                            <p:ajax process="@this" event="keyup" listener="#{DashboardManagedBean.searchWidget}" update="widget-list" delay="200"/>
                        </p:inputText>
                        <h:panelGroup id="widget-list" layout="block" styleClass="settings-dialog widgetChooser">
                            <c:choose>
                                <c:when test="#{not empty DashboardManagedBean.categoryListMap}">
                                    <ui:repeat value="#{DashboardManagedBean.categoryListMap}" var="entry">
                                        <div>
                                            <h2>
                                                #{entry.key.getExplicitName()}
                                                <ui:fragment rendered="#{not empty entry.key.image}">
                                                    <img src="#{request.contextPath}/api/asset/#{HomeUserManagedBean.encrypt(entry.key.image)}" />
                                                </ui:fragment>
                                            </h2>
                                            <div class="widget-list ui-g">
                                                <ui:repeat value="#{entry.value}" var="widget">
                                                    <div class="widget-detail ui-g-3" onclick="selectedWidget({'id':#{widget.id}})">
                                                        <div class="panel-heading">
                                                            <h3 class="panel-title">#{widget.name}</h3>
                                                            <ui:fragment rendered="#{not empty widget.image}">
                                                                <img src="#{request.contextPath}/api/asset/#{HomeUserManagedBean.encrypt(widget.image)}" />
                                                            </ui:fragment>
                                                            <div class="panel-desc">#{widget.description}</div>
                                                        </div>
                                                    </div>
                                                </ui:repeat>
                                            </div>
                                        </div>
                                    </ui:repeat>
                                </c:when>
                                <c:otherwise>
                                    <div class="searchError">#{msg['app.user.widget.search.not.fount']}</div>
                                </c:otherwise>
                            </c:choose>

                        </h:panelGroup>
                    </c:when>
                    <c:otherwise>
                        <ui:include src="widgetConfig.xhtml"/>
                    </c:otherwise>
                </c:choose>
            </div>
        </p:dialog>
        <input name="#{_csrf.parameterName}" type="hidden" value="#{_csrf.token}"/>
    </h:form>
</ui:composition>