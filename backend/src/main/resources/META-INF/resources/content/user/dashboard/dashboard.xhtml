<?xml version="1.0" encoding="UTF-8"?>
<ui:composition xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:c="http://java.sun.com/jsp/jstl/core"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:jsf="http://xmlns.jcp.org/jsf"
                xmlns:o="http://omnifaces.org/ui"
                xmlns:p="http://primefaces.org/ui">
    <div class="col-md-12">
        <h:form id="dashboard-form">
            <div class="panel animated zoomIn">
                <div class="panel-body">
                    <div class="panel-content">
                        <c:choose>
                            <c:when test="#{not empty HomeUserManagedBean.getProjects()}">
                                <div class="row">
                                    <div class="col-md-12 form-inline">
                                        <div class="form-group" style="display: block">
                                            <label for="inputProject">#{msg['app.user.dashboard']}</label>
                                            <p:selectOneMenu id="inputProject" style="width:250px" widgetVar="selectDashboard" value="#{HomeUserManagedBean.selectedId}" styleClass="form-control" onchange="window.location.hash='#'+this.value">
                                                <f:selectItem itemLabel="#{msg['app.user.select.dashboard']}" itemValue="" noSelectionOption="true"/>
                                                <f:selectItems itemLabel="#{entry.getExplicitName()}" itemValue="#{entry.getId()}" value="#{HomeUserManagedBean.getProjects()}" var="entry"/>
                                                <f:ajax listener="#{HomeUserManagedBean.updateSelectedProject}" render="@form"/>
                                            </p:selectOneMenu>
                                            <h:outputScript>
                                                $(function(){
                                                    var select = PF('selectDashboard');
                                                    var id = window.location.hash.split('#')[1];
                                                    if (window.location.hash.length >= 1 &amp;&amp; select.value != id &amp;&amp; !isNaN(parseInt(id))){
                                                        select.selectValue(id);
                                                    }
                                                });
                                            </h:outputScript>
                                            <c:choose>
                                                <c:when test="#{not empty HomeUserManagedBean.selectedProject}">
                                                    <p:commandButton class="btn btn-primary btn-add-widget"
                                                                     value="#{msg['app.user.add.widget.btn']}"
                                                                     onclick="PF('widgetChooser').show();"
                                                                     icon="fa fa-plus"/>
                                                    <p:commandButton actionListener="#{HomeUserManagedBean.forceRefresh}"
                                                                     icon="fa fa-refresh"
                                                                     update="@form"
                                                                     class="btn btn-primary pull-right"
                                                                     value="#{msg['app.user.refresh.tv.btn']}"
                                                                     process="@this" />
                                                    <a href="#{request.contextPath}/content/tv/index.xhtml?token=#{HomeUserManagedBean.selectedProject.token}"
                                                       target="_blank"
                                                       style="margin-left: 12px;"
                                                       class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-icon-left btn btn-primary pull-right">
                                                        <span class="ui-button-icon-left ui-icon ui-c fa fa-external-link"/>
                                                        <span class="ui-button-text ui-c">#{msg['app.user.project.dashboard']}</span>
                                                    </a>
                                                    <p:commandButton icon="fa fa-gears"
                                                                     class="btn btn-primary pull-right"
                                                                     onclick="PF('settings-dialog').show()"
                                                                     value="#{msg['app.user.settings.btn']}"
                                                                     process="@this" />
                                                    <p:commandButton icon="fa fa-desktop"
                                                                     class="btn btn-primary pull-right"
                                                                     update="widget-screen-form:screen-dialog-content"
                                                                     onclick="PF('screens-dialog').show()"
                                                                     value="#{msg['app.user.screen.btn']}"
                                                                     process="@this" />
                                                </c:when>
                                                <c:otherwise>
                                                    <p:button class="btn btn-primary btn-add-widget" icon="fa fa-plus" outcome="user/project/edit.xhtml" value="#{msg['app.user.dashboard.add']}"/>
                                                </c:otherwise>
                                            </c:choose>
                                        </div>
                                    </div>
                                </div>
                            </c:when>
                            <c:otherwise>
                                <div class="row">
                                    <div class="col-md-6">
                                        <p:button class="btn btn-primary" icon="fa fa-plus" outcome="user/project/edit.xhtml" value="#{msg['app.user.dashboard.add']}"/>
                                    </div>
                                </div>
                            </c:otherwise>
                        </c:choose>
                    </div>
                </div>
            </div>

            <div jsf:id="widget-visu">
                <c:if test="#{not empty HomeUserManagedBean.selectedProject}">
                    <div jsf:id="widget-visu-content">
                        <h:panelGroup id="widgets" layout="block" styleClass="panel animated zoomIn">
                            <o:commandScript action="#{DashboardManagedBean.updateScreen}" name="updatePosition"/>
                            <div class="panel-body">
                                <div class="panel-content">
                                    <c:set var="widgetList" value="#{HomeUserManagedBean.getWidgetResponses()}" />
                                    <c:choose>
                                        <c:when test="#{empty widgetList}">
                                            <pre class="no-widget">#{msg['app.user.widget.dashboard.noWidget']}</pre>
                                        </c:when>
                                        <c:otherwise>
                                            <style media="screen" type="text/css">
                                                <c:forEach items="#{widgetList}" var="widget">#{widget.css}</c:forEach>
                                                <c:forEach items="#{widgetList}" var="widget">
                                                    <c:if test="#{not empty widget.customCss}">#{widget.customCss}</c:if>
                                                </c:forEach>
                                            </style>
                                            <c:if test="#{HomeUserManagedBean.getErrorWidget() gt 0}">
                                                <div class="ui-messages ui-messages-noicon ui-widget">
                                                    <div class="ui-messages-error ui-corner-all">
                                                        <ul>
                                                            <li>
                                                                <span class="ui-messages-error-summary">
                                                                    <h:outputText value="#{HomeUserManagedBean.getString('app.user.widget.error', HomeUserManagedBean.getErrorWidget())}" escape="false"/>
                                                                    <p:commandLink actionListener="#{HomeUserManagedBean.relaunchWidgets()}" process="@this" update="@form" styleClass="link-fix">#{msg['app.user.widget.error.relaunchSync']}</p:commandLink>
                                                                </span>
                                                            </li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </c:if>
                                            <div class="grid-stack white grid-stack-#{HomeUserManagedBean.selectedProject.maxColumn eq null ? 5 : HomeUserManagedBean.selectedProject.maxColumn}" data-gs-animate="yes">
                                                <c:forEach items="#{widgetList}" var="widget">
                                                    <div class="grid-stack-item" data-gs-height="#{widget.height}" data-gs-width="#{widget.width}" data-gs-x="#{widget.col}" data-gs-y="#{widget.row}">
                                                        <div class="grid-stack-item-content widget #{widget.id} widget-#{widget.projectWidgetId}">
                                                            <img src="#{request.contextPath}/api/asset/#{HomeUserManagedBean.encrypt(widget.imageId)}" />
                                                            <p:commandLink
                                                                    actionListener="#{DashboardManagedBean.editWidget(widget.projectWidgetId)}"
                                                                    class="status #{widget.error ? 'error' : widget.warning ? 'warn' : '' }"
                                                                    process="@this"
                                                                    update="widgets-form:widget-dialog-content"
                                                                    oncomplete="PF('widgetChooser').show();"
                                                                    title="#{widget.error ? msg['app.user.widget.state.error'] :  widget.warning ? msg['app.user.widget.state.warning'] : msg['app.user.widget.state.ok'] }" >
                                                            </p:commandLink>
                                                            <p:commandButton action="#{DashboardManagedBean.deleteWidget(widget.projectWidgetId)}" class="btn btn-primary btn-widget" icon="fa fa-remove" process="@this" update="@form">
                                                                <p:confirm header="Confirmation" message="#{msg['app.user.delete.widget.btn']}" icon="ui-icon-alert"/>
                                                            </p:commandButton>
                                                            <p:commandButton
                                                                    actionListener="#{DashboardManagedBean.editWidget(widget.projectWidgetId)}"
                                                                    class="btn btn-primary btn-widget"
                                                                    icon="fa fa-edit"
                                                                    process="@this"
                                                                    update="widgets-form:widget-dialog-content"
                                                                    oncomplete="PF('widgetChooser').show();"
                                                                    style="margin-right: 5px"
                                                            >
                                                            </p:commandButton>
                                                        </div>
                                                    </div>
                                                </c:forEach>
                                            </div>
                                            <script type="text/javascript">
                                                $(function() {
                                                    var options = {
                                                        width: #{HomeUserManagedBean.selectedProject.maxColumn eq null ? 5 : HomeUserManagedBean.selectedProject.maxColumn},
                                                        cellHeight: #{HomeUserManagedBean.selectedProject.widgetHeight eq null ? 360/1.5: HomeUserManagedBean.selectedProject.widgetHeight/1.5},
                                                        verticalMargin: 10 };

                                                    var grid = $('.grid-stack');
                                                    grid.gridstack(options);
                                                    var data = grid.data('gridstack');
                                                    grid.on('change',function() {
                                                        var data = _.map($('.grid-stack .grid-stack-item:visible'), function (el) {
                                                            el = $(el);
                                                            var node = el.data('_gridstack_node');
                                                            return { col: node.x, row: node.y, size_x: node.width, size_y: node.height };
                                                        });
                                                        updatePosition({"widgetPositions":JSON.stringify(data)});
                                                    });
                                                });
                                            </script>
                                            <p:confirmDialog global="true" showEffect="fade" hideEffect="fade">
                                                <p:commandButton value="Yes" type="button" styleClass="ui-confirmdialog-yes btn btn-danger btn-xs" icon="fa fa-check" />
                                                <p:commandButton value="No" type="button" styleClass="ui-confirmdialog-no btn btn-primary btn-xs spaceleft" icon="fa fa-close" />
                                            </p:confirmDialog>
                                        </c:otherwise>
                                    </c:choose>
                                </div>
                            </div>
                        </h:panelGroup>
                        <!-- Include widget chooser -->
                        <ui:include src="widgetChooser.xhtml"/>
                        <!-- Include Screen Settings -->
                        <ui:include src="screens.xhtml"/>
                    </div>
                    <!-- Include Dashboard Settings -->
                    <ui:include src="settings.xhtml"/>
                </c:if>
            </div>
            <input name="#{_csrf.parameterName}" type="hidden" value="#{_csrf.token}"/>
        </h:form>
    </div>
</ui:composition>