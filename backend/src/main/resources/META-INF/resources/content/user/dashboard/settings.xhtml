<?xml version="1.0" encoding="UTF-8"?>
<ui:composition xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:jsf="http://xmlns.jcp.org/jsf"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:p="http://primefaces.org/ui" xmlns:c="http://java.sun.com/jsp/jstl/core">

    <p:dialog header="'#{SettingsManagedBean.homeUserManagedBean.selectedProject.name}' #{msg['app.user.settings.title']}"
              widgetVar="settings-dialog"
              id="settings-dialog"
              minHeight="40"
              modal="true"
              width="70%"
              resizable="false"
              responsive="true"
              draggable="false"
              closeOnEscape="true"
              dynamic="true">
        <div jsf:id="settings-dialog-content" class="settings-dialog">
            <p:tabView dynamic="true">
                <p:tab>
                    <f:facet name="title">
                        <i class="fa fa-sliders" aria-hidden="true"/>
                        #{msg['app.user.settings.display.title']}
                    </f:facet>
                    <h:form id="display">
                        <p:defaultCommand target="submit-config" />
                        <div class="panel-body" >
                            <div class="form-group">
                                <label for="name">#{msg['app.admin.project.field.name']} *</label>
                                <p:messages for="name" showIcon="false" autoUpdate="true" />
                                <p:inputText id="name"
                                             value="#{ SettingsManagedBean.projectName}"
                                             placeholder="#{msg['app.user.settings.dashboard.name.placeholder']}"
                                             styleClass="form-control"
                                             required="true"
                                             requiredMessage="#{msg['app.user.settings.dashboard.name.required']}"
                                             binding="#{ name }"
                                             widgetVar="dashboard-name"
                                >
                                    <p:ajax process="@this" event="keyup" delay="200" update="save-btn name"/>
                                </p:inputText>
                                <div class="widget-dialog-btn" jsf:id="save-btn">
                                    <p:commandButton action="#{SettingsManagedBean.updateProjectName}"
                                                     class="btn btn btn-primary"
                                                     icon="fa fa-check"
                                                     update="@form"
                                                     value="#{msg['app.user.settings.dashboard.save']}"
                                                     process="@form"
                                                     rendered="#{SettingsManagedBean.homeUserManagedBean.selectedProject.name ne SettingsManagedBean.projectName}"
                                    />
                                </div>
                            </div>
                        </div>
                        <div class="panel-heading clearfix">
                            <h3 class="panel-title">#{msg['app.user.settings.display.grid']}</h3>
                        </div>
                        <div class="panel-body" >
                            <div class="form-group spinner">
                                <label for="widgetHeight">#{msg['app.admin.project.field.widgetheight']}</label>
                                <p:spinner id="widgetHeight"
                                           value="#{SettingsManagedBean.homeUserManagedBean.selectedProject.widgetHeight}"
                                           styleClass="form-control"
                                           min="0"
                                >
                                    <p:ajax event="change" listener="#{SettingsManagedBean.updateProject}" update="dashboard-form:widget-visu-content"/>
                                </p:spinner>
                            </div>
                            <div class="form-group spinner">
                                <label for="maxColumn">#{msg['app.admin.project.field.maxcolumn']}</label>
                                <p:spinner id="maxColumn"
                                           value="#{SettingsManagedBean.homeUserManagedBean.selectedProject.maxColumn}"
                                           styleClass="form-control"
                                           min="0"
                                >
                                    <p:ajax event="change" listener="#{SettingsManagedBean.updateProject}" update="dashboard-form:widget-visu-content"/>
                                </p:spinner>
                            </div>
                            <p:remoteCommand id="submit-config" actionListener="#{SettingsManagedBean.updateProject}" />
                        </div>
                        <div class="panel-heading clearfix">
                            <h3 class="panel-title">#{msg['app.user.settings.display.style']}</h3>
                        </div>
                        <div class="panel-body" >
                            <p:inputTextarea id="projectCss"
                                             name="projectCss"
                                             styleClass="projectCss"
                                             value="#{SettingsManagedBean.homeUserManagedBean.selectedProject.cssStyle}"/>
                            <script>
                                $(function(){
                                    var codeMirror = CodeMirror.fromTextArea( document.getElementsByClassName("projectCss")[0],{
                                        lineNumbers: true,
                                        mode: "css",
                                        theme:"mdn-like",
                                        styleActiveLine: true,
                                        matchBrackets: true,
                                        autoCloseBrackets: true
                                    });
                                    setTimeout(function() {
                                        codeMirror.refresh();
                                    },100);

                                    codeMirror.on('change', function () {
                                        codeMirror.save();
                                    });
                                });
                            </script>
                        </div>
                        <input name="#{_csrf.parameterName}" type="hidden" value="#{_csrf.token}"/>
                        <div class="widget-dialog-btn">
                            <p:commandButton actionListener="#{SettingsManagedBean.updateProject}"
                                             class="btn btn-primary"
                                             value="#{msg['app.user.confirm.widget.btn']}"
                                             icon="fa fa-check"
                                             process="@this"
                                             oncomplete="if(!args.validationFailed){ PF('settings-dialog').hide();}"
                            />
                        </div>
                    </h:form>
                </p:tab>
                <p:tab>
                    <f:facet name="title">
                        <i class="fa fa-users" aria-hidden="true"/>
                        #{msg['app.user.settings.user.title']}
                    </f:facet>
                    <h:form>
                        <div class="panel-body">
                            <p:messages for="user-settings-message" showIcon="false" autoUpdate="true" />
                            <div class="form-group">
                                <label for="search-user">#{msg['app.user.settings.user.add.label']}</label>
                                <p:autoComplete id="search-user" value="#{SettingsManagedBean.searchUser}" completeMethod="#{SettingsManagedBean.completeUser}"
                                                var="user" itemLabel="#{user.username} #{user.fullname}" itemValue="#{user}" converter="userDtoConverter" forceSelection="true"
                                                styleClass="form-control" immediate="false">
                                    <p:ajax event="itemSelect"
                                            listener="#{SettingsManagedBean.addUser()}"
                                            update="@form" />
                                </p:autoComplete>
                            </div>
                            <c:set var="users" value="#{SettingsManagedBean.getUser()}" scope="request"/>
                            <div>#{users.size()} #{msg['app.user.settings.dashboard.user.added']}</div>
                            <ul class="list-user">
                                <ui:repeat value="#{users}" var="user">
                                    <li><i class="fa fa-user icon-space" aria-hidden="true"/> #{user.fullname} <p:commandButton actionListener="#{SettingsManagedBean.removeUser(user.id)}"
                                                                          class="btn btn-xs btn-danger btn-disconnect"
                                                                          update="@form"
                                                                          icon="fa fa-trash"
                                                                          value="#{msg['app.user.settings.dashboard.user.delete']}"
                                                                          process="@this"
                                    /></li>
                                </ui:repeat>
                            </ul>
                        </div>
                        <input name="#{_csrf.parameterName}" type="hidden" value="#{_csrf.token}"/>
                    </h:form>
                </p:tab>
                <p:tab>
                    <f:facet name="title">
                        <i class="fa fa-globe" aria-hidden="true"/>
                        #{msg['app.user.settings.general.title']}
                    </f:facet>
                    <div class="panel-body" >
                        <h:form id="settings-general">
                            <p:defaultCommand target="delete-dashboard" />
                            <p:commandButton id="delete-dashboard"
                                             class="btn btn-danger btn-with-icon"
                                             icon="fa fa-trash"
                                             action="#{SettingsManagedBean.delete}"
                                             value="#{msg['app.user.settings.dashboard.delete']}"
                                             process="@this"
                            >
                                <p:confirm header="#{msg['app.confirm.title']}" message="#{msg['app.confirm.sure']}" icon="ui-icon-alert" />
                            </p:commandButton>

                            <p:confirmDialog global="true" showEffect="fade" hideEffect="fade">
                                <p:commandButton value="#{msg['app.confirm.btn.yes']}" type="button" styleClass="ui-confirmdialog-yes btn btn-danger btn-xs" icon="fa fa-check" />
                                <p:commandButton value="#{msg['app.confirm.btn.no']}" type="button" styleClass="ui-confirmdialog-no btn btn-primary btn-xs spaceleft" icon="fa fa-close" />
                            </p:confirmDialog>
                            <input name="#{_csrf.parameterName}" type="hidden" value="#{_csrf.token}"/>
                        </h:form>
                    </div>
                </p:tab>
            </p:tabView>
        </div>
    </p:dialog>

</ui:composition>